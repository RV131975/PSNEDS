<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tech News Rotativo — RSS</title>
<style>
  :root{--bg:#0b1b2b;--card:#0e2134;--muted:#7ea0c9;--text:#e8f0fa;--accent:#4cc0ff}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,Roboto,system-ui,-apple-system,sans-serif;background:#0b1b2b;color:var(--text)}
  .wrap{min-height:100vh;display:grid;grid-template-rows:80px auto 80px;gap:18px;padding:24px}
  .top{display:flex;align-items:center;gap:16px}
  .brand{font-weight:800;letter-spacing:.06em;font-size:26px}
  .source{margin-left:auto;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 14px;font-size:13px;color:var(--muted)}
  .main{display:grid;grid-template-columns: minmax(280px, 380px) 1fr; gap:18px; align-items:start}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
  .panel h3{margin:0 0 10px;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}
  .headline{font-size:26px;font-weight:800;line-height:1.25;margin:0 0 12px}
  .desc{color:var(--muted);margin:0 0 10px}
  .cta a{color:var(--accent);text-decoration:none;font-weight:600}
  .list{display:grid;gap:12px;max-height:70vh;overflow:auto;padding-right:4px}
  .item{display:grid;grid-template-columns:120px 1fr;gap:14px;align-items:center;background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .thumb{width:120px;height:72px;object-fit:cover;border-radius:8px;background:#17314b}
  .item h4{margin:0;font-size:15px}
  .item p{margin:4px 0 0;font-size:12px;color:var(--muted)}
  .ticker{display:flex;align-items:center;overflow:hidden;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);border-radius:12px}
  .marquee{white-space:nowrap;animation:slide 28s linear infinite;padding:20px;font-size:18px;color:#dbe8f8}
  @keyframes slide{from{transform:translateX(100%)}to{transform:translateX(-100%)}}
  ::-webkit-scrollbar{height:8px;width:10px} ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div class="brand">PSNE • Tech News</div>
    <div class="source" id="sourceBox">Fonte: —</div>
  </header>

  <main class="main">
    <section class="panel">
      <h3>Em destaque</h3>
      <h1 class="headline" id="heroTitle">Carregando…</h1>
      <p class="desc" id="heroDesc">Buscando notícias dos portais selecionados.</p>
      <div class="cta"><a id="heroLink" href="#" target="_blank" rel="noopener">Ler mais →</a></div>
    </section>

    <section class="panel">
      <h3>Últimas do portal atual</h3>
      <div class="list" id="newsList"></div>
    </section>
  </main>

  <footer class="ticker">
    <div class="marquee" id="ticker">TechCrunch • The Verge • Ars Technica • WIRED • The Register — feed rotativo a cada 20s</div>
  </footer>
</div>

<script>
(() => {
  // ====== Configuração dos feeds ======
  const FEEDS = [
    { name: "TechCrunch",  url: "https://techcrunch.com/feed/" },
    { name: "The Verge",   url: "https://www.theverge.com/rss/index.xml" },
    { name: "Ars Technica",url: "https://feeds.arstechnica.com/arstechnica/index" },
    { name: "WIRED",       url: "https://www.wired.com/feed/rss" },
    { name: "The Register",url: "https://www.theregister.com/headlines.atom" } // Atom, vamos tratar igual
  ];

  // Proxy aberto para contornar CORS no browser. Troque por proxy próprio em produção.
  const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`;

  const ROTATE_MS = 20_000; // troca de portal a cada 20s
  const CACHE_TTL = 10 * 60_000; // 10 min

  // ====== Utilitários ======
  const byId = id => document.getElementById(id);
  const clean = (html) => (html||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
  const pickImg = (item) => {
    // tenta achar imagem em <media:content>, <enclosure>, <img> no conteúdo, senão usa picsum
    const m = item.media?.url || item.enclosure?.url || item.imgFromDesc;
    if (m) return m;
    const seed = encodeURIComponent((item.title||"thumb").slice(0,24));
    return `https://picsum.photos/seed/${seed}/240/144`;
  };

  // ====== Cache simples com TTL (localStorage) ======
  const cache = {
    get(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const {expires, data} = JSON.parse(raw);
        if (Date.now() > expires) { localStorage.removeItem(key); return null; }
        return data;
      }catch{ return null; }
    },
    set(key, data, ttlMs){ localStorage.setItem(key, JSON.stringify({expires: Date.now()+ttlMs, data})) }
  };

  // ====== Parser genérico (RSS/Atom) ======
  function parseFeed(xmlText){
    const xml = new DOMParser().parseFromString(xmlText, "text/xml");

    // Decide se é Atom ou RSS
    const isAtom = xml.documentElement.nodeName.toLowerCase().includes("feed");
    const items = [];

    if (isAtom){
      xml.querySelectorAll("entry").forEach(entry=>{
        const title = entry.querySelector("title")?.textContent?.trim();
        const link  = entry.querySelector("link")?.getAttribute("href");
        const summary = clean(entry.querySelector("summary")?.textContent || entry.querySelector("content")?.textContent || "");
        const pub = entry.querySelector("updated, published")?.textContent;
        // imagem: <link rel="enclosure"> ou img na descrição
        const enclosure = [...entry.querySelectorAll("link")].find(l => (l.getAttribute("rel")||"") === "enclosure");
        const imgFromDesc = (summary.match(/https?:\/\/\S+\.(?:jpg|jpeg|png|gif)/i)||[])[0];
        items.push({ title, link, desc: summary, pub: pub? new Date(pub) : null, enclosure: enclosure? {url: enclosure.getAttribute("href")} : null, imgFromDesc });
      });
    } else {
      xml.querySelectorAll("item").forEach(it=>{
        const title = it.querySelector("title")?.textContent?.trim();
        const link  = it.querySelector("link")?.textContent?.trim();
        const desc  = clean(it.querySelector("description")?.textContent || it.querySelector("content\\:encoded")?.textContent || "");
        const pub   = it.querySelector("pubDate")?.textContent;
        const media = it.querySelector("media\\:content, content")?.getAttribute?.("url");
        const enclosure = it.querySelector("enclosure");
        const imgFromDesc = (desc.match(/https?:\/\/\S+\.(?:jpg|jpeg|png|gif)/i)||[])[0];
        items.push({
          title, link, desc, pub: pub? new Date(pub) : null,
          media: media? {url: media}: null,
          enclosure: enclosure? {url: enclosure.getAttribute("url")} : null,
          imgFromDesc
        });
      });
    }

    // ordena por data desc, se houver
    items.sort((a,b)=>(b.pub?.getTime()||0)-(a.pub?.getTime()||0));
    return items;
  }

  async function fetchFeed(url){
    const key = `feed:${url}`;
    const cached = cache.get(key);
    if (cached) return cached;

    const txt = await fetch(PROXY(url), { cache:"no-store" }).then(r=>r.text());
    const items = parseFeed(txt).slice(0, 20); // guarda top 20
    cache.set(key, items, CACHE_TTL);
    return items;
  }

  // ====== Render ======
  function renderSource(name, items){
    byId("sourceBox").textContent = `Fonte: ${name}`;
    if (!items || items.length === 0){
      byId("heroTitle").textContent = "Sem itens disponíveis";
      byId("heroDesc").textContent = "Não foi possível carregar notícias deste portal agora.";
      byId("heroLink").href = "#";
      byId("newsList").innerHTML = "";
      return;
    }

    // Hero = primeiro item
    const hero = items[0];
    byId("heroTitle").textContent = hero.title || "Sem título";
    byId("heroDesc").textContent  = (hero.desc || "").slice(0, 180);
    byId("heroLink").href = hero.link || "#";

    // Lista (até 8 itens)
    const listHtml = items.slice(0, 8).map(it => {
      const thumb = pickImg(it);
      return `
        <article class="item">
          <img class="thumb" src="${thumb}" alt="">
          <div>
            <h4>${it.title || "Sem título"}</h4>
            <p>${(it.desc || "").slice(0, 120)}</p>
          </div>
        </article>
      `;
    }).join("");
    byId("newsList").innerHTML = listHtml;

    // Ajusta velocidade do ticker ao tamanho do texto
    const ticker = byId("ticker");
    const w = ticker.scrollWidth || 2000;
    ticker.style.animationDuration = `${Math.max(18, w/80)}s`;
  }

  // ====== Rotação de fontes ======
  let idx = 0, timer = null, loaded = {};
  async function showNext(){
    const feed = FEEDS[idx % FEEDS.length];
    idx++;

    try{
      if (!loaded[feed.name]) {
        loaded[feed.name] = await fetchFeed(feed.url);
      }
      renderSource(feed.name, loaded[feed.name]);
    }catch(e){
      console.warn("Falha ao carregar feed:", feed.name, e);
      renderSource(feed.name, []);
    }

    // agenda próxima rotação
    clearTimeout(timer);
    timer = setTimeout(showNext, ROTATE_MS);
  }

  // ====== Inicialização ======
  (async function init(){
    // pré-carrega todos em paralelo (não bloqueante)
    Promise.allSettled(FEEDS.map(f=>fetchFeed(f.url))).then(results=>{
      results.forEach((r,i)=>{ if (r.status==="fulfilled") loaded[FEEDS[i].name] = r.value; });
    });
    // começa exibindo o primeiro
    showNext();
  })();
})();
</script>
</body>
</html>
